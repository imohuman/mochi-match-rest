# WebSocket仕様書

## Websocket サーバについて

- クライアントからのリクエストに応じて、
  通知対象のクライアントにメッセージの転送を行います。

## 認証について

- WebSocket を利用するには、初期接続時にトークンを用いた認証を行います。
- トークンを用いた認証は Websocket サーバにて行います。
- トークンは別サーバ（API）にて発行されたものを使用します。
- 認証は以下の手順で行います。

  1. クライアントとサーバ間で Websocket 接続を確立します。
  2. サーバはクエリで受け取ったトークンの有効性を確認します
  3. 有効性が確認されたらそのまま Websocket 接続を継続します。

     - 認証エラーになった場合、エラーメッセージ送信後、Websocket 接続が切断されます。
     - 一定時間以内に認証のリクエストメッセージがサーバに通知されない場合 Websocket 接続が切断されます。

- 認証シーケンス

  ![認証](https://github.com/taniwhy/mochi-match-rest/blob/doc/out/websocket/%E8%AA%8D%E8%A8%BC/%E8%AA%8D%E8%A8%BC.png?raw=true)

## 通信ケース

| ケース         | 通信方向                       | イベント名   | 概要                                   |
| -------------- | ------------------------------ | ------------ | -------------------------------------- |
| ルーム参加     | クライアント -> サーバ         | join_req     | ルーム参加リクエスト時に使用します。   |
| ルーム参加通知 | サーバ -> クライアント         | notify_join  | ルーム参加の通知に使用します。         |
| チャット送信   | クライアント -> サーバ         | send_chat    | チャットメッセージの送信に使用します。 |
| チャット受信   | サーバ -> クライアント（全員） | receive_chat | チャットメッセージの受信に使用します。 |
| エラー受信     | サーバ -> クライアント         | error        | エラーメッセージ送信に使用します。     |